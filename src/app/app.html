<main class="container" [class.preview-mode]="currentPage() === 'preview'">
  <!-- ===== Input Page ===== -->
  <section class="page input-page" *ngIf="currentPage() === 'input'">
    <header>
      <h1>Speed Pie Chart</h1>

      <button class="contrast" (click)="toggleTheme()" aria-label="切換主題">
        <i class="fa-solid" [ngClass]="theme() === 'light' ? 'fa-moon' : 'fa-sun'"></i>
      </button>
    </header>

    <h2>輸入資料</h2>

    <form>
      <div *ngFor="let label of labels(); let i = index; trackBy: trackByIndex" class="item-row">
        <input
          type="text"
          [value]="labels()[i]"
          (input)="updateLabel(i, $any($event.target).value)"
          placeholder="項目名稱(選填)"
        />
        <input
          type="number"
          min="0"
          [value]="values()[i]"
          (input)="updateValue(i, +$any($event.target).value)"
          placeholder="數值"
          [class.danger]="invalidIndices().includes(i)"
        />

        <div class="item-buttons">
          <button type="button" class="primary" (click)="moveUp(i)"  [disabled]="i === 0" aria-label="上移">
            <i class="fa-solid fa-chevron-up"></i>
          </button>
          <button type="button" class="primary" (click)="moveDown(i)" [disabled]="i === labels().length - 1" aria-label="下移">
            <i class="fa-solid fa-chevron-down"></i>
          </button>
          <button type="button" class="danger" (click)="removeRow(i)" [disabled]="labels().length < 2" aria-label="刪除">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>

      <button type="button" (click)="addRow()" class="secondary full" [disabled]="labels().length >= 20">
        <i class="fa-solid fa-plus"></i> 新增項目
      </button>
    </form>

    <button type="button" (click)="goToPreview()" class="full">
      生成圖表 <i class="fa-solid fa-chevron-right"></i>
    </button>

    <p class="danger" *ngIf="hasError()">數值內容必須是不小於0的數字</p>

    <h2>圖表設定</h2>

    <form>
      <fieldset>
        <legend>圖表標題</legend>
        <input
        type="text"
        maxlength="50"
        [value]="chartTitle()"
        (input)="updateTitle($any($event.target).value)"
        placeholder="圖表標題(選填), 例如: 銷售分佈"
      />
      </fieldset>
      <fieldset class="option-fieldset">
        <legend>項目排序</legend>
        <label>
          <input
            type="radio"
            name="sort"
            value="input"
            [checked]="sortOrder() === 'input'"
            (change)="sortOrder.set('input'); updateSortedData()"
          />
          輸入資料
        </label>
        <label>
          <input
            type="radio"
            name="sort"
            value="desc"
            [checked]="sortOrder() === 'desc'"
            (change)="sortOrder.set('desc'); updateSortedData()"
          />
          降序
        </label>
        <label>
          <input
            type="radio"
            name="sort"
            value="asc"
            [checked]="sortOrder() === 'asc'"
            (change)="sortOrder.set('asc'); updateSortedData()"
          />
          升序
        </label>
      </fieldset>

      <fieldset class="option-fieldset">
        <legend>數據顯示</legend>

        <label>
          <input
            type="radio"
            name="labelMode"
            value="labelValue"
            [checked]="labelMode() === 'labelValue'"
            (change)="labelMode.set('labelValue');"
          />
          項目 + 數值
        </label>

        <label>
          <input
            type="radio"
            name="labelMode"
            value="value"
            [checked]="labelMode() === 'value'"
            (change)="labelMode.set('value');"
          />
          只顯示數值
        </label>

        <label>
          <input
            type="radio"
            name="labelMode"
            value="percent"
            [checked]="labelMode() === 'percent'"
            (change)="labelMode.set('percent');"
          />
          百分比
        </label>
        <label>
          <input
            type="radio"
            name="labelMode"
            value="none"
            [checked]="labelMode() === 'none'"
            (change)="labelMode.set('none');"
          />
          無
        </label>
      </fieldset>
    </form>
    <footer>
      <p>Created by Kei</p>
    </footer>
  </section>

  <!-- ===== Preview Page ===== -->
  <section class="page preview-page" *ngIf="currentPage() === 'preview'">
    <header class="noprint">
      <h2>預覽結果</h2>
      <button class="contrast" (click)="toggleTheme()" aria-label="切換主題">
        <i class="fa-solid" [ngClass]="theme() === 'light' ? 'fa-moon' : 'fa-sun'"></i>
      </button>
    </header>
    

    <div id="chartContainer" #chartContainer>
      <canvas baseChart [data]="chartData" [type]="chartType" [options]="chartOptions"></canvas>
    </div>

    <div class="grid noprint">
      <button (click)="downloadChart('png')" type="button">下載 PNG</button>
      <button (click)="downloadChart('jpg')" type="button">下載 JPG</button>
    </div>

    <table>
      <caption>
        數據總覽
      </caption>
      <thead>
        <tr>
          <th>項目</th>
          <th>數值</th>
          <th>百分比</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let label of renderLabels(); let i = index">
          <td>{{ label }}</td>
          <td>{{ renderValues()[i] }}</td>
          <td>{{ (renderValues()[i] / getTotal()) * 100 | number : '1.1-1' }}%</td>
        </tr>
      </tbody>
    </table>

    <button class="secondary full noprint" type="button" (click)="goToInput()">
      <i class="fa-solid fa-chevron-left"></i> 返回
    </button>

    <footer>
      <p>Made with Speed Pie Chart</p>
      <p class="noprint">Created by Kei</p>
    </footer>
  </section>
</main>
